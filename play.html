<html>
  <head>
    <title>Rummi Assistant</title>
    <style type='text/css'>
      span.tilecolour-R { background: red; color: white }
      span.tilecolour-T { background: aqua; color: black }
      span.tilecolour-Y { background: orange; color: black }
      span.tilecolour-B { background: black; color: white }
      #solution li {
	  margin: 1ex;
	  border: 1px solid black;
	  padding: 2ex 2ex 2ex 1ex;
	  list-style: none;
	  width: fit-content;
	  background: #e0e0e0;
	  display: inline-block;
      }
      li > span { margin-left: 1ex; padding: 4px; width: 4ex; display: inline-block; text-align: center }
      li > span.joker { font-weight: bold }
      #tosolve span { margin-left: 1ex; padding: 4px }
      #tosolve span.joker { font-weight: bold }
      #tosolve { margin: 1ex; line-height: 2em; }
      #solvebutton { height: 2em; width: 8em; }
      #table2 {
	  display: flex;
	  flex-direction: row;
      }
      .column {
	  display: flex;
	  flex-direction: column;
      }
    </style>
    <script src='./rummi.js'></script>
    <script>
      function parse_tiles(str) {
	const pieces = str.toUpperCase().split(/[ ,]+/),
	      tiles = [];
	let prev = 0;

	for (const t of pieces) {
	  let tc = colour(prev), digits = '';
	  for (c in Colours) if (t.includes(Colours[c])) tc = c;
	  for (d of t) if (Number.isInteger(d - 0)) digits = digits.concat(d);
	  if (!digits) digits = rank(prev);
	  prev = card(tc, digits);
	  if (t.includes('J'))
	    for (j in Jokers)
	      if (t == Jokers[j]) prev = (j - 0 + 1) << 4;
	  if (prev) tiles.push(prev);
	}
	return tiles;
      }

      function dosolve() {
	const tdiv = document.getElementById('table'),
	      hdiv = document.getElementById('hand'),
	      groups = [];
	for (let box of tdiv.querySelectorAll('textarea')) {
	  let contents = box.value.split('\n').map(parse_tiles);
	  box.value = contents.map(cardsstr).join('\n');
	  groups.push(contents);
	}
	for (let box of hdiv.querySelectorAll('textarea')) {
	  let contents = box.value.split('\n').map(parse_tiles);
	  box.value = contents.map(cardsstr).join('\n');
	  groups.push(contents);
	}

	const li = document.querySelector('#tosolve'),
	      display = document.getElementById('solution'),
	      arr = groups.flat().flat();
	arr.sort(tilesort);
	
	while (li.firstChild) li.removeChild(li.firstChild);
	arr.map(c => prettytile(c, document)).forEach(el => {
	  li.appendChild(el);
	  li.append(document.createTextNode(' '));
	});
	while (display.firstChild) display.removeChild(display.firstChild);

	let valid = validate(arr);
	if (valid.ok) {
	  document.getElementById('solvestatus').textContent = 'Working...';
	  console.log(arr);
	  workersolve(arr);
	} else {
	  console.log(valid);
	  document.getElementById('solvestatus').textContent = valid.err + ' ' + cardstr(valid.val);
	}
      }

      function validate(arr) {
	for (let i = 0; i < arr.length; ++i) {
	  if (!arr[i]) return { ok: false, err: 'invalid tile' };
	  if ((i > 1) && (arr[i] == arr[i-1]) && (arr[i] == arr[i-2])) {
	    return { ok: false, err: 'too many tiles', val: arr[i] };
	  }
	}
	return { ok: true };
      }
      
      function get_worker() {
	if (!window.solve_worker) solve_worker = new Worker('./worker.js');
	return solve_worker;
      }

      function workersolve(tiles) {
	get_worker();
	let starttm = new Date().getTime();

	solve_worker.onmessage = (msg) => {
	  console.log('solve:', msg.data);
	  if (msg.data.completed)
	    solve_complete(tiles, starttm, msg.data);
	  else {
	    const seconds = (new Date().getTime() - msg.data.start_time)/1000;
	    document.getElementById('solvestatus').textContent = 'Working ' + Math.floor(seconds) + 's';
	  }
	}
	solve_worker.postMessage(tiles);
	console.log('waiting for solve');
      }

      function addcolumn(ev) {
	const col = ev.target.parentElement.parentElement,
	      next = col.parentElement.insertBefore(document.createElement('div'), null);
	next.classList.add('column');
	next.appendChild(ev.target.parentElement.cloneNode(true));
	for (let g of col.querySelectorAll('.group')) {
	  let ng = g.cloneNode(true);
	  activate_group(ng);
	  next.appendChild(ng);
	}
      }

      function delcolumn(ev) {}
      function edit(ev) {
	let next = ev.target.parentElement.nextElementSibling;
	console.log('edit', ev);
	if (!next) {
	  next = ev.target.parentElement.cloneNode(true);
	  next.querySelector('input').value = '';
	  activate_group(next);
	  ev.target.parentElement.parentElement.appendChild(next);
	}
      }

      function drag_group(ev) {
	console.log(ev);
      }
      function drop_group(ev) {
	console.log(ev);
      }
      function delete_group(ev) {
	const g = ev.target.parentElement;
	g.parentElement.removeChild(g);
      }
      function activate_column(div) {
	div.querySelectorAll('.buttons button').forEach(b => {
	  if (b.classList.contains('add'))
	    b.addEventListener('click', addcolumn);
	  if (b.classList.contains('del'))
	    b.addEventListener('click', delcolumn);
	});
      }
      function activate_group(div) {
	div.querySelector('.handle').addEventListener('dragend', drag_group);
	div.querySelector('input').addEventListener('input', edit);
	div.querySelector('.delgroup').addEventListener('click', delete_group);
	div.querySelector('.handle').addEventListener('drop', drop_group);
      }
      function start() {
	console.log('start');
	document.querySelectorAll('.column').forEach(activate_column);
	document.querySelectorAll('.group').forEach(g => {
	  activate_group(g);
	});
      }
      window.onload = start;
    </script>
  </head>
  <body>
    <div>
      <p>Colours: R T Y B / Ranks: 1 - 13 / Jokers: JS JD JM JC</p>
    </div>
    <div id='table2' class='holder'>
      <div class='column'>
	<div class='buttons'>
	  <button type='button' class='add'>add</button>
	  <button type='button' class='del'>del</button>
	</div>
	<div class='group'>
	  <span class='handle' draggable='true'>O</span>
	  <input></input>
	  <button type='button' class='delgroup'>x</button>
	</div>
      </div>
    </div>
    <div id='table'>
      <h3>Table</h3>
      <textarea cols='25' rows='10'></textarea>
      <textarea cols='25' rows='10'></textarea>
      <textarea cols='25' rows='10'></textarea>
    </div>
    <div id='hand'>
      <h3>Hand</h3>
      <textarea cols='40' rows='3'></textarea>
    </div>
    
    <button type='button' id='solvebutton' onclick='dosolve()'>Solve</button>
    <div id='tosolve'></div>
    <p id='solvestatus'></p>
    <ul id='solution'></ul>
  </body>
</html>

  
